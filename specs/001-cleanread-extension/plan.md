# Implementation Plan: CleanRead - Automatic Sidebar Ad Blocker

**Branch**: `001-cleanread-extension` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-cleanread-extension/spec.md`

## Summary

CleanRead is a Chrome browser extension that automatically detects and hides sidebar ads on Dealmoon.com and StackOverflow.com. The extension uses hardcoded CSS selectors to identify and hide ads immediately on page load (<50ms) and monitors for dynamically inserted ads using MutationObserver (200ms detection, 100ms debounce). Users can toggle the extension on/off per domain via a simple popup UI. The technical approach uses TypeScript (strict mode), Vite + @crxjs/vite-plugin for bundling, Chrome Manifest V3 with content scripts for DOM manipulation, and chrome.storage.sync for per-domain state persistence. No background service worker is needed for this simple use case.

## Technical Context

**Language/Version**: TypeScript (strict mode enabled)
**Primary Dependencies**: Vite 5.x, @crxjs/vite-plugin, @types/chrome
**Storage**: Chrome Storage API (local only, no sync)
**Testing**: Performance benchmarks (<50ms filter application), integration tests
**Target Platform**: Chrome 120+ browser extension (Manifest V3)
**Project Type**: Browser extension (Chrome extension structure)
**Performance Goals**: <50ms filter application (NON-NEGOTIABLE), <50ms settings propagation
**Constraints**: No external network requests, <50MB memory footprint, offline-only operation
**Scale/Scope**: Single-user browser extension, lightweight footprint

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- ✅ TypeScript with strict mode enabled
- ✅ Manifest V3 compliance
- ✅ Performance: Filter application <50ms (NON-NEGOTIABLE)
- ✅ Privacy: No external network requests (offline-only)
- ✅ Build: Vite + @crxjs/vite-plugin
- ✅ Target: Chrome 120+ only
- ✅ Code quality: ESLint + Prettier enforcement
- ⚠ Minimal dependencies (justify each new dependency)
- ⚠ Memory footprint <50MB

## Project Structure

### Documentation (this feature)

```text
specs/001-cleanread-extension/
├── plan.md              # This file
├── spec.md              # Feature specification (completed)
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
CleanRead/
├── public/
│   └── icon.png                 # Extension icon (128x128)
│
├── src/                         # Source code (IMPORTANT: ALL source files here)
│   ├── popup/
│   │   ├── popup.html          # Popup UI structure (referenced in manifest)
│   │   ├── popup.ts            # Popup logic (toggle state, reload tab)
│   │   └── popup.css           # Popup styling
│   │
│   ├── content/
│   │   └── content.ts          # Content script (ad detection, hiding, observer)
│   │
│   └── types/
│       └── index.ts            # TypeScript types (DomainState, AdSelectors)
│
├── manifest.json               # Manifest V3 configuration (source, NOT dist)
├── vite.config.ts              # Vite + @crxjs/vite-plugin configuration
├── tsconfig.json               # TypeScript strict mode configuration
├── package.json                # Dependencies and scripts
├── .eslintrc.json              # ESLint configuration (optional)
├── .prettierrc                 # Prettier configuration (optional)
│
└── dist/                       # Build output (gitignored, load in chrome://extensions)
    ├── manifest.json           # Transformed by @crxjs
    ├── popup.html              # Bundled popup
    ├── popup.js                # Compiled popup script
    ├── content.js              # Compiled content script
    └── icon.png                # Copied from public/
```

**Structure Decision**: Browser extension structure following Manifest V3 architecture. Key points:

1. **All source files in `src/`**: popup.html, popup.ts, popup.css, content.ts
2. **manifest.json points to `src/` paths**: `"default_popup": "src/popup/popup.html"`, `"js": ["src/content/content.ts"]`
3. **@crxjs/vite-plugin handles transformations**: Automatically converts src paths to dist paths during build
4. **Build output in `dist/`**: Load this directory in chrome://extensions (Developer Mode)
5. **No background service worker**: Not needed for this simple use case (no persistent state, no message passing)

## Technical Flow

### 1. Page Load Flow (User Story 1 - P1)

```
Page loads → DOMContentLoaded event
    ↓
content.ts injects
    ↓
getCurrentDomain() → extract domain from window.location.hostname
    ↓
checkDomainState(domain) → chrome.storage.sync.get(domain)
    ↓
if state === false → EXIT (disabled for this domain)
    ↓
if state === true OR undefined (default ON)
    ↓
scanAndClean() → querySelectorAll(AD_SELECTORS)
    ↓
Apply display:none to all matches
    ↓
Performance: MUST complete in <50ms
```

### 2. Dynamic Content Flow (User Story 2 - P2)

```
MutationObserver created in content.ts
    ↓
Observer callback triggered on DOM changes
    ↓
Debounce: 100ms (prevent rapid re-scans)
    ↓
scanAndClean() → querySelectorAll(AD_SELECTORS)
    ↓
Apply display:none to newly added ad elements
    ↓
Performance: Detection within 200ms of insertion
```

### 3. Popup Toggle Flow (User Story 3 - P3)

```
User clicks extension icon
    ↓
popup.html loads, popup.ts executes
    ↓
getCurrentTab() → chrome.tabs.query({ active: true, currentWindow: true })
    ↓
Extract domain from tab.url
    ↓
chrome.storage.sync.get(domain) → load current state
    ↓
Display toggle (ON/OFF)
    ↓
User toggles switch
    ↓
chrome.storage.sync.set({ [domain]: newState })
    ↓
chrome.tabs.reload(tab.id) → reload page
    ↓
Performance: Reload within 100ms of toggle
```

## Ad Selectors (Hardcoded)

### Domain-Specific Selectors

**Dealmoon.com**:
```typescript
const DEALMOON_SELECTORS = [
  '.area_right',
  '.ad-container',
  '[class*="ad-"]'
];
```

**StackOverflow.com**:
```typescript
const STACKOVERFLOW_SELECTORS = [
  '#sidebar .s-sidebarwidget--yellow',
  '.everyonelovesstackoverflow'
];
```

### Generic Ad Selectors

```typescript
const GENERIC_SELECTORS = [
  'iframe[src*="doubleclick"]',
  'div[id^="google_ads"]'
];
```

### Implementation Strategy

```typescript
// content.ts
const AD_SELECTORS = [
  ...DEALMOON_SELECTORS,
  ...STACKOVERFLOW_SELECTORS,
  ...GENERIC_SELECTORS
];

function scanAndClean(): void {
  const startTime = performance.now();

  AD_SELECTORS.forEach(selector => {
    const elements = document.querySelectorAll(selector);
    elements.forEach(el => {
      (el as HTMLElement).style.display = 'none';
    });
  });

  const duration = performance.now() - startTime;
  // Assert: duration < 50ms
}
```

## Data Model

### Domain State (chrome.storage.sync)

```typescript
// Storage format
{
  "dealmoon.com": true,      // enabled
  "stackoverflow.com": true, // enabled
  "example.com": false       // disabled
}

// TypeScript interface
interface DomainState {
  [domain: string]: boolean; // true = enabled, false = disabled
}
```

**Default Behavior**: If domain not in storage, default to `true` (enabled).

### Types Definition

```typescript
// src/types/index.ts

export interface DomainState {
  [domain: string]: boolean;
}

export interface AdSelectors {
  dealmoon: string[];
  stackoverflow: string[];
  generic: string[];
}
```

## Performance Requirements

### Critical Path Performance

1. **Initial Scan (<50ms)**:
   - `querySelectorAll()` for all AD_SELECTORS
   - Apply `display: none` to matches
   - Target: <50ms from DOMContentLoaded

2. **MutationObserver Throttling**:
   - Debounce: 100ms
   - Prevents rapid re-scans on highly dynamic pages

3. **Popup Toggle (<100ms)**:
   - State change + tab reload within 100ms

### Memory Management

- No memory leaks from MutationObserver
- Cleanup on single-page app navigation
- Target: <5MB memory footprint

## Build Process

### Development Workflow

```bash
# 1. Install dependencies
npm install

# 2. Start development server
npm run dev
# → Outputs to dist/ with hot reload

# 3. Load extension in Chrome
# Open chrome://extensions
# Enable "Developer mode"
# Click "Load unpacked"
# Select the dist/ folder

# 4. Make changes to src/ files
# @crxjs hot-reloads automatically
```

### Production Build

```bash
npm run build
# → Optimized bundle in dist/
# → Load dist/ in chrome://extensions for testing
```

### Path Transformations (@crxjs/vite-plugin)

**Source (manifest.json)**:
```json
{
  "action": {
    "default_popup": "src/popup/popup.html"
  },
  "content_scripts": [{
    "js": ["src/content/content.ts"]
  }]
}
```

**Output (dist/manifest.json)** - Automatically transformed:
```json
{
  "action": {
    "default_popup": "popup.html"
  },
  "content_scripts": [{
    "js": ["content.js"]
  }]
}
```

## Complexity Tracking

No constitutional violations. All requirements met:

- ✅ TypeScript strict mode
- ✅ Manifest V3
- ✅ Vite + @crxjs/vite-plugin
- ✅ No external APIs
- ✅ Performance <50ms
- ✅ Chrome 120+ target

## Phase Execution Plan

### Phase 0: Project Setup
- Initialize package.json with Vite, @crxjs/vite-plugin, TypeScript
- Configure vite.config.ts with @crxjs plugin
- Configure tsconfig.json with strict mode
- Create manifest.json with Manifest V3 structure
- Create src/ directory structure

### Phase 1: Core Ad Blocking (User Story 1)
- Implement content.ts with scanAndClean()
- Hardcode AD_SELECTORS
- Implement domain state check
- Test on dealmoon.com and stackoverflow.com
- Validate <50ms performance

### Phase 2: Dynamic Detection (User Story 2)
- Add MutationObserver to content.ts
- Implement 100ms debounce
- Test on dynamic content sites
- Validate <200ms detection

### Phase 3: Popup UI (User Story 3)
- Create popup.html with toggle UI
- Implement popup.ts with state management
- Implement tab reload on toggle
- Style popup.css
- Test toggle persistence

### Phase 4: Testing & Polish
- Performance benchmarks (<50ms validation)
- Memory leak testing
- Bundle size validation (<50KB)
- Console error checking on target sites
